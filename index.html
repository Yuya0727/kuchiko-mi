<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å£ã‚³ãƒŸä½œæˆã‚µãƒãƒ¼ãƒˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#fdf8f2 0%,#f0e9df 100%);min-height:100vh;font-family:'Noto Sans JP',sans-serif;display:flex;justify-content:center;align-items:flex-start;padding:24px 16px 48px}
  #app{width:100%;max-width:640px;background:#fff;border-radius:20px;box-shadow:0 8px 48px rgba(120,80,30,.12);overflow:hidden;animation:fadeIn .4s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  .header{background:linear-gradient(135deg,#4a3728 0%,#7a5c3e 100%);color:#fff;padding:36px 32px 28px;text-align:center}
  .logo{font-size:28px;margin-bottom:8px;color:#e8c87a}
  h1{font-family:'Noto Serif JP',serif;font-size:22px;font-weight:600;letter-spacing:.1em;margin-bottom:8px}
  .subtitle{font-size:13px;color:rgba(255,255,255,.75);line-height:1.8;margin-bottom:20px}
  .steps{display:flex;align-items:center;justify-content:center}
  .step-dot{width:30px;height:30px;border-radius:50%;border:2px solid rgba(255,255,255,.3);color:rgba(255,255,255,.4);font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .3s}
  .step-dot.active{border-color:#e8c87a;color:#e8c87a;background:rgba(232,200,122,.15)}
  .step-line{width:40px;height:2px;background:rgba(255,255,255,.2);transition:all .3s}
  .step-line.active{background:#e8c87a}
  .body{padding:28px 28px 32px;animation:slideIn .3s ease}
  .section-title{font-family:'Noto Serif JP',serif;font-size:18px;font-weight:600;color:#2d1f14;margin-bottom:8px;display:flex;align-items:center;gap:10px}
  .step-badge{background:#4a3728;color:#e8c87a;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
  .hint{font-size:12px;color:#9e8570;margin-bottom:20px}
  .cat-block{margin-bottom:20px}
  .cat-label{font-size:12px;font-weight:700;color:#7a5c3e;letter-spacing:.08em;margin-bottom:10px;text-transform:uppercase}
  .chip-group{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 16px;border-radius:100px;border:1.5px solid #d5c4b0;background:#fdf8f2;color:#4a3728;font-size:13px;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif}
  .chip:hover{border-color:#7a5c3e;background:#f5ece0}
  .chip.active{background:#4a3728;color:#e8c87a;border-color:#4a3728}
  .gender-group{display:flex;gap:12px;margin-bottom:24px}
  .gender-btn{flex:1;padding:14px;border-radius:12px;border:1.5px solid #d5c4b0;background:#fdf8f2;color:#4a3728;font-size:15px;font-weight:700;cursor:pointer;transition:all .15s;font-family:'Noto Serif JP',serif;text-align:center}
  .gender-btn:hover{border-color:#7a5c3e;background:#f5ece0}
  .gender-btn.active{background:#4a3728;color:#e8c87a;border-color:#4a3728}
  .field-group{margin-bottom:20px}
  label.field-label{display:block;font-size:14px;font-weight:700;color:#4a3728;margin-bottom:10px}
  input[type=text],textarea{width:100%;padding:12px 14px;border-radius:10px;border:1.5px solid #d5c4b0;font-size:14px;font-family:'Noto Sans JP',sans-serif;color:#2d1f14;outline:none;background:#fdf8f2;transition:border .2s}
  input[type=text]:focus,textarea:focus{border-color:#7a5c3e}
  textarea{resize:vertical;line-height:1.7}
  .nav-row{display:flex;justify-content:space-between;align-items:center;margin-top:28px;gap:12px}
  .btn-next{background:#4a3728;color:#e8c87a;border:none;border-radius:100px;padding:12px 32px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;letter-spacing:.05em;display:block;margin-left:auto;margin-top:28px}
  .btn-back{background:transparent;color:#9e8570;border:1.5px solid #d5c4b0;border-radius:100px;padding:11px 24px;font-size:14px;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
  .btn-generate{background:linear-gradient(135deg,#4a3728,#7a5c3e);color:#e8c87a;border:none;border-radius:100px;padding:13px 28px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;letter-spacing:.05em;box-shadow:0 4px 16px rgba(74,55,40,.3)}
  .btn-copy{background:#e8c87a;color:#2d1f14;border:none;border-radius:100px;padding:13px 32px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;letter-spacing:.05em;width:100%;max-width:300px}
  .btn-reset{background:transparent;color:#9e8570;border:1.5px solid #d5c4b0;border-radius:100px;padding:11px 24px;font-size:14px;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
  .loading{text-align:center;padding:48px 0}
  .spinner{width:48px;height:48px;border:4px solid #e8c87a;border-top-color:#4a3728;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
  .loading-text{color:#9e8570;font-size:14px}
  .review-box{background:#fdf8f2;border:1.5px solid #d5c4b0;border-radius:14px;padding:20px 22px;margin-bottom:20px}
  .stars{color:#e8c87a;font-size:22px;letter-spacing:2px;margin-bottom:12px}
  .review-text{font-size:14px;line-height:2;color:#2d1f14;white-space:pre-wrap}
  .action-row{display:flex;justify-content:center;margin-bottom:20px}
  .guide-box{background:#f5f0e8;border-left:3px solid #7a5c3e;border-radius:10px;padding:16px 18px;margin-bottom:24px}
  .guide-title{font-size:13px;font-weight:700;color:#4a3728;margin-bottom:10px}
  .guide-list{padding-left:18px;font-size:13px;color:#5a4030;line-height:2}
  .setup-screen{padding:40px 28px;text-align:center}
  .setup-icon{font-size:40px;margin-bottom:16px}
  .setup-title{font-family:'Noto Serif JP',serif;font-size:20px;color:#2d1f14;margin-bottom:8px}
  .setup-desc{font-size:13px;color:#9e8570;line-height:1.8;margin-bottom:24px}
  .api-input-wrap{position:relative;margin-bottom:16px}
  .api-input{width:100%;padding:12px 14px;border-radius:10px;border:1.5px solid #d5c4b0;font-size:13px;font-family:'Noto Sans JP',sans-serif;background:#fdf8f2;color:#2d1f14;outline:none}
  .api-input:focus{border-color:#7a5c3e}
  .btn-start{width:100%;background:#4a3728;color:#e8c87a;border:none;border-radius:100px;padding:14px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
  .api-note{font-size:11px;color:#b0967e;margin-top:8px}
  .error-box{background:#fff0f0;border:1.5px solid #f5b8b8;border-radius:10px;padding:14px 16px;margin-bottom:16px;font-size:13px;color:#c0392b;line-height:1.8}
  .hidden{display:none}
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="logo">âœ¦</div>
    <h1>å£ã‚³ãƒŸä½œæˆã‚µãƒãƒ¼ãƒˆ</h1>
    <p class="subtitle">ã„ãã¤ã‹ã®è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€<br>Googleå£ã‚³ãƒŸã®æ–‡ç« ã‚’è‡ªå‹•ã§ä½œæˆã—ã¾ã™</p>
    <div class="steps" id="steps-indicator">
      <div class="step-dot active" id="dot1">1</div>
      <div class="step-line" id="line1"></div>
      <div class="step-dot" id="dot2">2</div>
      <div class="step-line" id="line2"></div>
      <div class="step-dot" id="dot3">3</div>
    </div>
  </div>

  <!-- APIã‚­ãƒ¼è¨­å®šç”»é¢ï¼ˆé™¢é•·å°‚ç”¨ï¼š?setupï¼‰ -->
  <div id="screen-setup" class="setup-screen hidden">
    <div class="setup-icon">ğŸ”‘</div>
    <p class="setup-title">é™¢é•·ç”¨ãƒ»åˆæœŸè¨­å®š</p>
    <p class="setup-desc">Anthropicã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>ä¸€åº¦å…¥åŠ›ã™ã‚‹ã¨ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
    <div class="api-input-wrap">
      <input class="api-input" id="api-key-input" type="password" placeholder="sk-ant-api03-...">
    </div>
    <button class="btn-start" onclick="saveApiKey()">è¨­å®šã—ã¦å§‹ã‚ã‚‹</button>
    <p class="api-note">APIã‚­ãƒ¼ã¯ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</p>
  </div>

  <!-- Step 1: æ€§åˆ¥ + ç—‡çŠ¶ -->
  <div id="screen-1" class="body hidden">
    <h2 class="section-title"><span class="step-badge">1</span>æ€§åˆ¥ãƒ»ãŠæ‚©ã¿ã®ç—‡çŠ¶ã‚’ãƒã‚§ãƒƒã‚¯</h2>
    <div class="field-group">
      <label class="field-label">æ€§åˆ¥</label>
      <div class="gender-group">
        <button class="gender-btn" id="gender-male" onclick="selectGender('ç”·æ€§')">ğŸ‘¨ ç”·æ€§</button>
        <button class="gender-btn" id="gender-female" onclick="selectGender('å¥³æ€§')">ğŸ‘© å¥³æ€§</button>
      </div>
    </div>
    <label class="field-label">ãŠæ‚©ã¿ã ã£ãŸç—‡çŠ¶ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
    <p class="hint">å½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„</p>
    <div id="symptom-area"></div>
    <button class="btn-next" onclick="goStep(2)">æ¬¡ã¸ â†’</button>
  </div>

  <!-- Step 2: æ¥åº—å‹•æ©Ÿãƒ»é€šé™¢å›æ•° -->
  <div id="screen-2" class="body hidden">
    <h2 class="section-title"><span class="step-badge">2</span>æ¥åº—ã®ãã£ã‹ã‘ãƒ»é€šé™¢å›æ•°</h2>
    <div class="field-group">
      <label class="field-label">æ¥åº—ã®ãã£ã‹ã‘</label>
      <div class="chip-group" id="motive-area"></div>
      <input type="text" id="custom-motive" placeholder="æ¥åº—ã®ãã£ã‹ã‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="margin-top:10px;display:none">
    </div>
    <div class="field-group">
      <label class="field-label">é€šé™¢å›æ•°</label>
      <div class="chip-group" id="visit-area"></div>
    </div>
    <div class="nav-row">
      <button class="btn-back" onclick="goStep(1)">â† æˆ»ã‚‹</button>
      <button class="btn-generate" style="background:#4a3728;color:#e8c87a;border:none;border-radius:100px;padding:12px 32px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif" onclick="goStep(3)">æ¬¡ã¸ â†’</button>
    </div>
  </div>

  <!-- Step 3: æ„Ÿæƒ³ -->
  <div id="screen-3" class="body hidden">
    <h2 class="section-title"><span class="step-badge">3</span>æ–½è¡“ã‚’å—ã‘ã¦ã®ã”æ„Ÿæƒ³</h2>
    <p class="hint">è¤‡æ•°é¸æŠã§ãã¾ã™</p>
    <div class="chip-group" id="feeling-area"></div>
    <div class="field-group" style="margin-top:24px">
      <label class="field-label">è‡ªç”±ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
      <textarea id="free-comment" rows="3" placeholder="ãã®ä»–ã€æ°—ã«ãªã£ãŸã“ã¨ã‚„å°è±¡ã«æ®‹ã£ãŸã“ã¨ãŒã‚ã‚Œã°è‡ªç”±ã«ã©ã†ã"></textarea>
    </div>
    <div class="nav-row">
      <button class="btn-back" onclick="goStep(2)">â† æˆ»ã‚‹</button>
      <button class="btn-generate" onclick="generateReview()">âœ¦ å£ã‚³ãƒŸæ–‡ã‚’ç”Ÿæˆã™ã‚‹</button>
    </div>
  </div>

  <!-- Step 4: çµæœ -->
  <div id="screen-4" class="body hidden">
    <h2 class="section-title"><span class="step-badge">âœ¦</span>å£ã‚³ãƒŸæ–‡ãŒå®Œæˆã—ã¾ã—ãŸ</h2>
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p class="loading-text">æ–‡ç« ã‚’ä½œæˆä¸­ã§ã™â€¦</p>
    </div>
    <div id="result-area" style="display:none">
      <div id="error-area" class="error-box hidden"></div>
      <div id="review-wrap">
        <div class="review-box">
          <div class="stars">â˜…â˜…â˜…â˜…â˜…</div>
          <p class="review-text" id="review-output"></p>
        </div>
        <div class="action-row">
          <button class="btn-copy" id="copy-btn" onclick="copyReview()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="guide-box">
          <p class="guide-title">ğŸ“Œ Googleãƒãƒƒãƒ—ã¸ã®æŠ•ç¨¿æ‰‹é †</p>
          <ol class="guide-list">
            <li>ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</li>
            <li>Googleãƒãƒƒãƒ—ã§ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸ã‚’QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰é–‹ã</li>
            <li>ã€Œå£ã‚³ãƒŸã‚’æ›¸ãã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è²¼ã‚Šä»˜ã‘ã‚‹</li>
            <li>æ˜Ÿã®æ•°ã‚’é¸ã‚“ã§é€ä¿¡ï¼</li>
          </ol>
        </div>
      </div>
      <div class="nav-row">
        <button class="btn-back" onclick="goStep(3)">â† å…¥åŠ›ã«æˆ»ã‚‹</button>
        <button class="btn-reset" onclick="resetAll()">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
      </div>
    </div>
  </div>
</div>

<script>
const HARDCODED_API_KEY = "";

const SYMPTOM_CATEGORIES = [
  { label: "ç—›ã¿ãƒ»ã“ã‚Š", items: ["è‚©ã“ã‚Š","è…°ç—›","é¦–ã®ç—›ã¿","è†ã®ç—›ã¿","è‚¡é–¢ç¯€ã®ç—›ã¿","èƒŒä¸­ã®ç—›ã¿","é ­ç—›","æ‰‹è¶³ã®ã—ã³ã‚Œ","è‚˜ã®ç—›ã¿","è¶³é¦–ã®ç—›ã¿"] },
  { label: "å§¿å‹¢ãƒ»ä½“å‹", items: ["çŒ«èƒŒ","éª¨ç›¤ã®ã‚†ãŒã¿","Oè„šãƒ»Xè„š","å·»ãè‚©","ä½“ã®ãƒãƒ©ãƒ³ã‚¹ã®æ‚ªã•","è„šé•·å·®","å´å¼¯ç—‡"] },
  { label: "ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ€ªæˆ‘", items: ["ã‚¹ãƒãƒ¼ãƒ„éšœå®³","è‚‰é›¢ã‚Œ","æ»æŒ«","ãƒ†ãƒ‹ã‚¹è‚˜ãƒ»ã‚´ãƒ«ãƒ•è‚˜","é‡çƒè‚©","ã‚ªã‚¹ã‚°ãƒƒãƒ‰ç—…","ãƒ©ãƒ³ãƒŠãƒ¼è†"] },
  { label: "è‡ªå¾‹ç¥çµŒãƒ»ãã®ä»–", items: ["å†·ãˆãƒ»ã‚€ãã¿","ç–²åŠ´æ„Ÿãƒ»å€¦æ€ æ„Ÿ","ç¡çœ ã®è³ªä½ä¸‹","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç”£å¾Œã®ä¸èª¿","ã‚ã¾ã„ãƒ»è€³é³´ã‚Š","å‹•æ‚¸ãƒ»æ¯åˆ‡ã‚Œ"] },
  { label: "é¡é–¢ç¯€ãƒ»æ­¯ãã—ã‚Š", items: ["é¡é–¢ç¯€ç—‡","æ­¯ãã—ã‚Šãƒ»é£Ÿã„ã—ã°ã‚Š","å£ãŒé–‹ãã«ãã„","é¡ã®ç—›ã¿ãƒ»éŸ³"] },
  { label: "çœ¼ç²¾ç–²åŠ´ãƒ»é ­éƒ¨", items: ["çœ¼ç²¾ç–²åŠ´","ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","ç›®ã®å¥¥ã®ç—›ã¿","åé ­ç—›","å¾Œé ­éƒ¨ã®å¼µã‚Š"] },
  { label: "ç¥çµŒç—›ãƒ»ã—ã³ã‚Œ", items: ["åéª¨ç¥çµŒç—›","è‚‹é–“ç¥çµŒç—›","è¶³è£ã®ã—ã³ã‚Œ","æŒ‡å…ˆã®ã—ã³ã‚Œ","è…•ã®ã—ã³ã‚Œ"] },
  { label: "æ›´å¹´æœŸãƒ»ãƒ›ãƒ«ãƒ¢ãƒ³", items: ["æ›´å¹´æœŸç—‡çŠ¶","ãƒ›ãƒƒãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥","ã‚¤ãƒ©ã‚¤ãƒ©ãƒ»æ°—åˆ†ã®è½ã¡è¾¼ã¿","ç”Ÿç†ç—›ãƒ»ç”Ÿç†ä¸é †"] },
  { label: "äº¤é€šäº‹æ•…ãƒ»ã‚€ã¡æ‰“ã¡", items: ["ã‚€ã¡æ‰“ã¡ç—‡","äº¤é€šäº‹æ•…å¾Œã®ç—›ã¿","äº‹æ•…å¾Œã®é ­ç—›","äº‹æ•…å¾Œã®åãæ°—"] },
];

const MOTIVES = ["ãƒãƒƒãƒˆã§æ¤œç´¢ã—ã¦è¦‹ã¤ã‘ãŸ","çŸ¥äººãƒ»å‹äººã®ç´¹ä»‹","è¿‘ãã«ã‚ã£ãŸã‹ã‚‰","ä»¥å‰ã‹ã‚‰é€šã£ã¦ã„ãŸ","å£ã‚³ãƒŸã‚’è¦‹ã¦","ãƒãƒ©ã‚·ãƒ»åºƒå‘Šã‚’è¦‹ã¦","ãã®ä»–"];
const VISIT_COUNTS = ["åˆã‚ã¦","2ã€œ3å›ç›®","5å›ä»¥ä¸Š","å®šæœŸçš„ã«é€šã£ã¦ã„ã‚‹"];
const FEELINGS = [
  "æ–½è¡“å¾Œã™ãã«æ¥½ã«ãªã£ãŸ","æ•°å›é€šã£ã¦æ”¹å–„ã—ãŸ","ç—›ã¿ãŒãªããªã£ãŸ","ä½“ãŒè»½ããªã£ãŸ",
  "ã‚ˆãçœ ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ","å§¿å‹¢ãŒè‰¯ããªã£ãŸ","ã¾ãŸæ¥ãŸã„ã¨æ€ã£ãŸ",
  "å…ˆç”Ÿã®å¯¾å¿œãŒä¸å¯§ã ã£ãŸ","èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸ","é™¢å†…ãŒæ¸…æ½”ã§è½ã¡ç€ã",
  "äºˆç´„ãŒå–ã‚Šã‚„ã™ã„","é§è»Šå ´ãŒä½¿ã„ã‚„ã™ã„","å­ã©ã‚‚é€£ã‚Œã§ã‚‚å®‰å¿ƒ","ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¸ã®é…æ…®ãŒã‚ã‚‹"
];

let state = { gender:"", symptoms:[], motive:"", visitCount:"åˆã‚ã¦", feelings:[], freeComment:"" };
let currentStep = 0;

function getApiKey(){ return HARDCODED_API_KEY || localStorage.getItem("anthropic_api_key") || ""; }

function saveApiKey(){
  const key = document.getElementById("api-key-input").value.trim();
  if(!key){ alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  localStorage.setItem("anthropic_api_key", key);
  alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’ä½¿ã„å§‹ã‚ã¾ã™ã€‚");
  goStep(1);
  document.getElementById("steps-indicator").style.display="flex";
}

function selectGender(g){
  state.gender = g;
  document.getElementById("gender-male").classList.toggle("active", g==="ç”·æ€§");
  document.getElementById("gender-female").classList.toggle("active", g==="å¥³æ€§");
}

function init(){
  buildSymptoms(); buildMotives(); buildVisitCounts(); buildFeelings();
  const params = new URLSearchParams(window.location.search);
  if(params.has("setup")){
    // ?setupä»˜ããªã‚‰å¸¸ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º
    showScreen("setup");
    document.getElementById("steps-indicator").style.display="none";
  } else if(HARDCODED_API_KEY || localStorage.getItem("anthropic_api_key")){
    goStep(1);
  } else {
    showScreen("setup");
    document.getElementById("steps-indicator").style.display="none";
  }
}
    document.getElementById("steps-indicator").style.display="none";
  } else if(getApiKey()){
    goStep(1);
  } else {
    document.body.innerHTML='<div style="text-align:center;padding:80px 20px;font-family:sans-serif;color:#888;"><p style="font-size:18px;line-height:2;">ãŸã ã„ã¾æº–å‚™ä¸­ã§ã™ã€‚<br>é™¢é•·ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚</p></div>';
  }
}

function showScreen(name){
  ["setup","1","2","3","4"].forEach(s=>{
    const el = document.getElementById(s==="setup"?"screen-setup":"screen-"+s);
    if(el) el.classList.add("hidden");
  });
  const target = document.getElementById(name==="setup"?"screen-setup":"screen-"+name);
  if(target) target.classList.remove("hidden");
}

function goStep(n){
  currentStep = n;
  showScreen(String(n));
  updateStepIndicator(n);
  document.getElementById("steps-indicator").style.display = n===4 ? "none" : "flex";
  window.scrollTo({top:0, behavior:"smooth"});
}

function updateStepIndicator(n){
  [1,2,3].forEach(i=>{
    const dot = document.getElementById("dot"+i);
    if(dot) dot.classList.toggle("active", n>=i);
  });
  [1,2].forEach(i=>{
    const line = document.getElementById("line"+i);
    if(line) line.classList.toggle("active", n>i);
  });
}

function buildChipGroup(containerId, items, stateKey, isMulti){
  const container = document.getElementById(containerId);
  if(!container) return;
  container.innerHTML = "";
  items.forEach(item=>{
    const btn = document.createElement("button");
    btn.className = "chip";
    btn.textContent = item;
    if(isMulti){ if(state[stateKey].includes(item)) btn.classList.add("active"); }
    else{ if(state[stateKey]===item) btn.classList.add("active"); }
    btn.onclick = ()=>{
      if(isMulti){
        if(state[stateKey].includes(item)){ state[stateKey]=state[stateKey].filter(i=>i!==item); btn.classList.remove("active"); }
        else{ state[stateKey].push(item); btn.classList.add("active"); }
      } else {
        state[stateKey]=item;
        container.querySelectorAll(".chip").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        if(containerId==="motive-area"){
          document.getElementById("custom-motive").style.display = item==="ãã®ä»–"?"block":"none";
        }
      }
    };
    container.appendChild(btn);
  });
}

function buildSymptoms(){
  const area = document.getElementById("symptom-area");
  SYMPTOM_CATEGORIES.forEach(cat=>{
    const block = document.createElement("div"); block.className="cat-block";
    const label = document.createElement("div"); label.className="cat-label"; label.textContent=cat.label;
    const group = document.createElement("div"); group.className="chip-group";
    block.appendChild(label); block.appendChild(group); area.appendChild(block);
    cat.items.forEach(item=>{
      const btn = document.createElement("button"); btn.className="chip"; btn.textContent=item;
      if(state.symptoms.includes(item)) btn.classList.add("active");
      btn.onclick=()=>{
        if(state.symptoms.includes(item)){ state.symptoms=state.symptoms.filter(i=>i!==item); btn.classList.remove("active"); }
        else{ state.symptoms.push(item); btn.classList.add("active"); }
      };
      group.appendChild(btn);
    });
  });
}
function buildMotives(){ buildChipGroup("motive-area",MOTIVES,"motive",false); }
function buildVisitCounts(){ buildChipGroup("visit-area",VISIT_COUNTS,"visitCount",false); }
function buildFeelings(){ buildChipGroup("feeling-area",FEELINGS,"feelings",true); }

async function generateReview(){
  state.freeComment = document.getElementById("free-comment").value;
  const motive = state.motive==="ãã®ä»–" ? document.getElementById("custom-motive").value : state.motive;
  goStep(4);
  document.getElementById("loading").style.display="block";
  document.getElementById("result-area").style.display="none";

  const prompt = `ã‚ãªãŸã¯æ•´ä½“é™¢ã®æ–½è¡“ã‚’å—ã‘ãŸãŠå®¢æ§˜ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€Googleãƒãƒƒãƒ—ã®å£ã‚³ãƒŸã¨ã—ã¦è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„æ–‡ç« ã‚’1ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€æ€§åˆ¥ã€‘${state.gender || "æœªå›ç­”"}
ã€æ¥åº—ã®ãã£ã‹ã‘ã€‘${motive || "ç‰¹ã«ãªã—"}
ã€é€šé™¢å›æ•°ã€‘${state.visitCount}
ã€æ‚©ã‚“ã§ã„ãŸç—‡çŠ¶ãƒ»ç–¾æ‚£ã€‘${state.symptoms.length>0 ? state.symptoms.join("ã€") : "ç‰¹ã«ãªã—"}
ã€æ–½è¡“ã‚’å—ã‘ã¦ã®æ„Ÿæƒ³ã€‘${state.feelings.length>0 ? state.feelings.join("ã€") : "ç‰¹ã«ãªã—"}
ã€è‡ªç”±ã‚³ãƒ¡ãƒ³ãƒˆã€‘${state.freeComment || "ãªã—"}

æ¡ä»¶ï¼š
- 200ã€œ350æ–‡å­—ç¨‹åº¦
- æ€§åˆ¥ã«åˆã£ãŸè‡ªç„¶ãªè©±ã—è¨€è‘‰ã§ã€ãŠå®¢æ§˜æœ¬äººãŒæ›¸ã„ãŸã‚ˆã†ãªãƒªã‚¢ãƒ«ãªæ–‡ä½“
- ç”·æ€§ãªã‚‰ã€Œã€œã§ã—ãŸã€ã€Œã€œã¾ã™ã€ãªã©è½ã¡ç€ã„ãŸãƒˆãƒ¼ãƒ³ã€å¥³æ€§ãªã‚‰ã€Œã€œã§ã—ãŸï¼ã€ãªã©å°‘ã—æŸ”ã‚‰ã‹ã„ãƒˆãƒ¼ãƒ³
- SEOã«åŠ¹æœçš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç—‡çŠ¶åã€æ•´ä½“é™¢ãªã©ã®ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’è‡ªç„¶ã«ç››ã‚Šè¾¼ã‚€
- æ˜Ÿ5ã¤ã®ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå£ã‚³ãƒŸã¨ã—ã¦æ›¸ã
- ç®‡æ¡æ›¸ãã‚„è¨˜å·ã¯ä½¿ã‚ãšã€æµã‚Œã‚‹æ–‡ç« ã«ã™ã‚‹
- ã“ã®æ•´ä½“é™¢ã¯é™¢é•·ãŠä¸€äººã§æ–½è¡“ã—ã¦ã„ã‚‹ãŸã‚ã€Œã‚¹ã‚¿ãƒƒãƒ•ã€ã€Œã‚¹ã‚¿ãƒƒãƒ•ã®æ–¹ã€…ã€ãªã©ã®è¡¨ç¾ã¯çµ¶å¯¾ã«ä½¿ã‚ãšã€ã€Œå…ˆç”Ÿã€ã¾ãŸã¯ã€Œé™¢é•·å…ˆç”Ÿã€ã¨ã„ã†è¡¨ç¾ã‚’ä½¿ã†ã“ã¨
- æ–‡ç« ã®ã¿è¿”ç­”ã—ã€ä½™è¨ˆãªèª¬æ˜ã‚„å‰ç½®ãã¯ä¸è¦`;

  const errorArea = document.getElementById("error-area");
  const reviewWrap = document.getElementById("review-wrap");
  errorArea.classList.add("hidden");
  reviewWrap.style.display="block";

  try{
    const apiKey = getApiKey();
    if(!apiKey){
      throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é™¢é•·ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚");
    }
    const res = await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-api-key": apiKey,
        "anthropic-version":"2023-06-01",
        "anthropic-dangerous-direct-browser-access":"true"
      },
      body:JSON.stringify({model:"claude-sonnet-4-6",max_tokens:1000,messages:[{role:"user",content:prompt}]})
    });
    if(!res.ok){
      const errData = await res.json().catch(()=>({}));
      const msg = errData.error?.message || `HTTPã‚¨ãƒ©ãƒ¼ ${res.status}`;
      if(res.status===401){
        localStorage.removeItem("anthropic_api_key");
        throw new Error("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚é™¢é•·ç”¨URLï¼ˆ?setupï¼‰ã‹ã‚‰å†è¨­å®šã—ã¦ãã ã•ã„ã€‚");
      }
      throw new Error(msg);
    }
    const data = await res.json();
    const text = data.content?.map(b=>b.text||"").join("").trim();
    if(!text) throw new Error("æ–‡ç« ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
    document.getElementById("review-output").textContent = text;
  } catch(e){
    errorArea.textContent = "âš  " + e.message;
    errorArea.classList.remove("hidden");
    reviewWrap.style.display="none";
  }
  document.getElementById("loading").style.display="none";
  document.getElementById("result-area").style.display="block";
}

function copyReview(){
  const text = document.getElementById("review-output").textContent;
  navigator.clipboard.writeText(text).then(()=>{
    const btn = document.getElementById("copy-btn");
    btn.textContent = "âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
    setTimeout(()=>{ btn.textContent="ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼"; },2500);
  });
}

function resetAll(){
  state = { gender:"", symptoms:[], motive:"", visitCount:"åˆã‚ã¦", feelings:[], freeComment:"" };
  document.getElementById("free-comment").value="";
  document.getElementById("custom-motive").value="";
  document.getElementById("custom-motive").style.display="none";
  document.getElementById("gender-male").classList.remove("active");
  document.getElementById("gender-female").classList.remove("active");
  document.getElementById("symptom-area").innerHTML="";
  buildSymptoms(); buildMotives(); buildVisitCounts(); buildFeelings();
  goStep(1);
}

init();
</script>
</body>
</html>

